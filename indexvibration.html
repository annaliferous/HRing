<!doctype html>
<html>
    <head>

        <title>Communicating from Node.js to an Arduino</title>
        
        <!--<script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js'></script>-->
        <!--<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>-->
       <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js" integrity="sha512-xbQU0+iHqhVt7VIXi6vBJKPh3IQBF5B84sSHdjKiSccyX/1ZI7Vnkt2/8y8uruj63/DVmCxfUNohPNruthTEQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
       <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
       <script type="text/javascript" src="/haptics.js"></script>

       <style>
        .slidecontainer {
          width: 100%;
        }
        
        .slider {
          -webkit-appearance: none;
          width: 100%;
          height: 25px;
          background: #d3d3d3;
          outline: none;
          opacity: 0.7;
          -webkit-transition: .2s;
          transition: opacity .2s;
        }
        
        .slider:hover {
          opacity: 1;
        }
        
        .slider::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 25px;
          height: 25px;
          background: #04AA6D;
          cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
          width: 25px;
          height: 25px;
          background: #04AA6D;
          cursor: pointer;
        }
        /* 
 * Always set the map height explicitly to define the size of the div element
 * that contains the map. 
 */
  #map {
    height: 100%;
  }
  
  /* 
   * Optional: Makes the sample page fill the window. 
   */
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
        </style>
    </head>
    <body>

        <h1>Communicating from Node.js to an Arduino</h1>

        <button id="lightOn">Turn Light On</button>
        <button id="lightOff">Turn Light Off</button><br><br>
        <p id="isSupported">Vibration is not supported on this device</p>
       
        <button id="singlevibration" onclick="vibrateapi()">vibrate-with-new-api</button><br>

        <button id="singlevibration" onclick="normalvibrateapi()">normalvibration</button><br>
        <button id="singlevibration" onclick="middlevibrateapi()">middlevibration</button><br>
        <button id="singlevibration" onclick="fastvibrateapi()">fastvibration with new method</button><br>

        <h1>Custom Range Slider</h1>
        <p>Drag the slider to display the current value.</p>

        <div class="slidecontainer">
        <input type="range" min="1" max="180" value="1" class="slider" id="myRange">
        <p>Value: <span id="demo"></span></p>
        </div>
        <div id="map"></div>  

        <script>
            
        //var socket = io("ws://localhost:5500");
        var socket = io('http://10.163.181.68:5501');
        //var socket = io('http://192.168.178.22:5501');
        document.getElementById('lightOn').onclick = function() {
            
            socket.emit('lights', { "status":"1" });
                
        };
            
        document.getElementById('lightOff').onclick = function(){
               
            socket.emit('lights', { "status":"0" });
            
        };
        
        function vibrate(ms){
        const para = document.getElementById('isSupported')
        //navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;  
         // if(navigator.vibrate){
            para.innerHTML = "Vibration is supported on this device"
            navigator.vibrate(ms);
            console.log("vibration activated");
          //}
          
        }

        function vibrateapi(){
            var on = 100, off = 70, duration = 100;
            Haptics.pwm(duration, on, off);
            console.log("vibration activated");
        }
        function fastvibrateapi(){
            var on = 290, off = 10, duration = 300;
            Haptics.pwm(duration, on, off);
            console.log("vibration activated");     
        }
      function middlevibrateapi(){
            var on = 230, off = 70, duration = 300;
            Haptics.pwm(duration, on, off);
            console.log("vibration activated");     
        }
      function normalvibrateapi(){
            var on = 150, off = 150, duration = 300;
            Haptics.pwm(duration, on, off);
            console.log("vibration activated");     
        }

        const value = "Hello, server!";
        socket.emit("message", value);

        var slider = document.getElementById("myRange");
        var output = document.getElementById("demo");


        output.innerHTML = slider.value;

        slider.oninput = function() {
        output.innerHTML = this.value;
        socket.emit('servoposition', { "status":output.innerHTML });
        }

        function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 8,
      center: { lat: 48.137154, lng: 11.576124 },
      mapTypeId: "terrain",
    });
    const elevator = new google.maps.ElevationService();
    const infowindow = new google.maps.InfoWindow({});
    var marker = new google.maps.Marker({
      position: { lat: 48.137154, lng: 11.576124 },
      map: map,
      draggable: true,
      title: 'Your position'
    });

    const infowindowoption = {
      map:map,
      anchor:marker,
      shouldFocus:true

  }
    infowindow.open(infowindowoption);
    //infowindow.open(map);
    // Add a listener for the click event. Display the elevation for the LatLng of
    // the click inside the infowindow.
    map.addListener("click", (event) => {
      displayLocationElevation(event.latLng, elevator, infowindow);
    });

    google.maps.event.addListener(marker, 'dragstart', function(event) {
      console.log("start postion changed");
      displayLocationElevation(event.latLng, elevator, infowindow);
      //setTimeout(displayLocationElevation, 1000);
      console.log(displayLocationElevation(event.latLng, elevator, infowindow));
    });

    google.maps.event.addListener(marker, 'drag', function(event) {
      console.log(" postion changed");
      //setTimeout(() => {
        //displayLocationElevation(event.latLng, elevator, infowindow); 
        //}, 500);      

      displayLocationElevation(event.latLng, elevator, infowindow);
      
      //setInterval(displayLocationElevation, 1000);
      
      
    });

    google.maps.event.addListener(marker, 'dragend', function(event) {
      console.log("finally postion changed");
      displayLocationElevation(event.latLng, elevator, infowindow);
      console.log(displayLocationElevation(event.latLng, elevator, infowindow));
      //vibrate(0);
    });



  }
  function vibrationactivated(){
    console.log("vibration activated in 1000 mellisecond");
  }
  var Tinitial=0;
  var Tcurrenttime;  
  function displayLocationElevation(location, elevator, infowindow) {
    // Initiate the location request
    elevator
      .getElevationForLocations({
        locations: [location],
      })
      .then(({ results }) => {
        infowindow.setPosition(location);
        // Retrieve the first result
        if (results[0]) {
          socket.emit('servoposition_elevation', { "status":results[0].elevation.toString() });
          var intensity=maprange(results[0].elevation,0,2600,0,500);
          console.log(intensity);
          var on = intensity, off = duration-intensity, duration = 500;
          //Haptics.pwm(duration, on, off)
            
            
              Tcurrenttime=Date.now();
              console.log("this time in melli second",Tcurrenttime);
              
              if(Tcurrenttime>Tinitial+duration){
                Haptics.pwm(duration, on, off);
                Tinitial=Tcurrenttime;
              }
              else{
                
              } 
            
          // Open the infowindow indicating the elevation at the clicked position.
          infowindow.setContent(
            "The elevation at this point <br>is " +
              results[0].elevation +
              " meters."
          );
        } else {
          infowindow.setContent("No results found");
        }
      })
      .catch((e) =>
        infowindow.setContent("Elevation service failed due to: " + e)
      );
  }
  function maprange(value,min1,max1,min2,max2){
    return((value-min1)*(max2-min2))/(max1-min1)+min2;
  }
  
  window.initMap = initMap;
        </script>
       <script
       src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD255av8K7KhBUMOaLPMwk4hX116Jkv6_U&callback=initMap&v=weekly"
       defer
     ></script> 
    </body>
</html>
