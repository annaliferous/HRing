<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HRing Trial Run</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            position: relative;
        }

        .outline {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 1000px !important;
            min-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .headline {
            text-align: center;
            margin-bottom: 30px;
        }

        .headline p {
            font-size: 1.4rem;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        label {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        input[type="text"] {
            width: 100px;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            text-align: center;
            font-weight: 600;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        input[type="text"]:focus {
            outline: none;
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1),
                0 0 20px rgba(255, 255, 255, 0.3);
        }

        .slidecontainer {
            width: 100wh;
            margin: 30px 0;
        }

        .slider {
            -webkit-appearance: none;
            width: 100% !important;
            max-width: 900px;
            height: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            transition: all 0.3s ease;
            position: relative;
        }

        .slider:hover {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        .button {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        p {
            margin: 15px 0;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
        }

        span {
            font-weight: 700;
            color: #fff;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            min-width: 40px;
            text-align: center;
        }

        /*Canvas*/
        .canvas-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .canvas {
            border: 1px none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .grid-container div {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            padding: 10px;
        }

        .grid-container div:hover {
            transform: scale(1.05);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <!-- Calibration Screen -->
    <section id="calibration" class="calibration">
        <div class="container">
            <div class="outline">
                <label for="participation_id">Participation ID:</label>
                <input type="text" id="participation_id" maxlength="4" size="4" />
                <br /><br />

                <div class="headline">
                    <p>Please click "Send" when you start to feel any pressure</p>
                </div>

                <div class="slidecontainer">
                    <input type="range" min="0" max="100" value="0" class="slider" id="calibration_slider" />
                    <p>Value: <span id="demo">0</span></p>
                    <button class="button" id="calibration_send">Send</button>
                </div>
            </div>
        </div>
    </section>

    <!--Slider Task Screen-->
    <section id="screen" class="screen" style="display: none">
        <div class="container">
            <div class="outline">
                <div class="headline">
                    <p>Please move the circle to the end point</p>
                </div>
                <div class="slidecontainer">
                    <input type="range" min="0" max="100" value="0" class="slider" id="screen_slider" />
                </div>
            </div>
        </div>
    </section>
    <section id="questionnaire" class="questionnaire" style="display: none;">
        <!-- Canvas Section -->
        <div class="container" id="canvas_section_container">
            <div class="outline">
                <div class="headline">
                    <p>Please select a fitting canvas</p>
                </div>
                <div class="grid-container">
                    <div id="rise" class="canvas-container">
                        <canvas class="canvas" id="riseCanvas" width="200" height="200"></canvas>
                        <button class="button" id="rise_button" onclick="buttonFunctions('rise')">
                            Select
                        </button>
                    </div>
                    <div id="fall" class="canvas-container">
                        <canvas class="canvas" id="fallCanvas" width="200" height="200"></canvas>
                        <button class="button" id="fall_button" onclick="buttonFunctions('fall')">
                            Select
                        </button>
                    </div>
                    <div id="olymp" class="canvas-container">
                        <canvas class="canvas" id="olympCanvas" width="200" height="200"></canvas>
                        <button class="button" id="olymp_button" onclick="buttonFunctions('olymp')">
                            Select
                        </button>
                    </div>
                    <div id="tartarus" class="canvas-container">
                        <canvas class="canvas" id="tartarusCanvas" width="200" height="200"></canvas>
                        <button class="button" id="tartarus" onclick="buttonFunctions('tartarus')">
                            Select
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intensity Section -->
        <div class="container" id="intensity_container">
            <div class="outline">
                <div class="headline">
                    <p>Experiencing the haptic sensations was pleasant to me.</p>
                </div>
                <div class="slidecontainer">
                    <input type="range" min="0" max="100" value="0" class="slider" id="intensity_slider" />
                    <div class="slider-labels">
                        <span>Strongly Disagree</span>
                        <span>Strongly Agree</span>
                    </div>
                </div>
                <button class="button" id="intensity_send">Enter</button>
                <button class="button" id="intensity_return">Go Back</button>
            </div>
        </div>

        <!-- Height Section -->
        <div class="container" id="height_container">
            <div class="outline">
                <div class="headline">
                    <p>The haptic sensations resembled those I experience in real life.</p>
                </div>
                <div class="slidecontainer">
                    <input type="range" min="0" max="100" value="0" class="slider" id="height_slider" />
                    <div class="slider-labels">
                        <span>Strongly Disagree</span>
                        <span>Strongly Agree</span>
                    </div>
                </div>
                <button class="button" id="height_send">Enter</button>
                <button class="button" id="height_return">Go Back</button>
            </div>
        </div>
    </section>

    <script>
        // Initial SetUp
        const calibrationSection = document.getElementById("calibration");
        const screenSection = document.getElementById("screen");
        const questionnaireSection = document.getElementById("questionnaire");

        const calibrationSlider = document.getElementById("calibration_slider");
        const screenSlider = document.getElementById("screen_slider");
        const participationIdInput = document.getElementById("participation_id");
        const calibrationOutput = document.getElementById("demo");

        const url = "http://localhost:3000/save/";

        let startTime, stopTime;
        let calibrationValue = 0;
        let participation_id = 0;
        let participation_id_matrix = 0;
        let shuffledConditionMatrix = [];
        let currentModeIndex = 0;

        // Slider Drag for touch (no lagging)
        let isDragging = false;

        function startDrag(e) {
            isDragging = true;
            updateSlider(e);
        }
        function endDrag() {
            isDragging = false;
        }
        function drag(e) {
            if (isDragging) updateSlider(e);
        }
        function updateSlider(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        }

        [calibrationSlider, screenSlider].forEach((slider) => {
            slider.addEventListener("mousedown", startDrag);
            slider.addEventListener("touchstart", startDrag);
        });
        document.addEventListener("mousemove", drag);
        document.addEventListener("mouseup", endDrag);
        document.addEventListener("touchmove", drag);
        document.addEventListener("touchend", endDrag);

        // Calibration
        calibrationSlider.addEventListener("input", () => {
            calibrationOutput.textContent = calibrationSlider.value;
            //TODO
            let currentCalVal = calibrationSlider.value;
            let sendCurrentCalVal = url + "main/" + currentCalVal;
            console.log(`Current CalVal "${currentCalVal}"`);
            fetch(sendCurrentCalVal).catch((err) =>
                console.error("‚ùå Fetch error:", err)
            );
        });
        document.getElementById("calibration_send").addEventListener("click", () => {
            if (!participationIdInput.value) {
                alert("Please enter a Participation ID!");
                return;
            }
            calibrationValue = parseInt(calibrationSlider.value);
            participation_id = parseInt(participationIdInput.value);
            /* participation_id_matrix =
              parseInt(participationIdInput.value) % modeMatrix.length;
              
           */
            // Setup condition matrix for this participant
            setupConditionMatrix(participation_id);
            // Send calibrationValue + participantId
            fetch(url + "participationId/" + participation_id);
            fetch(url + "calibrationValue/" + calibrationValue);

            choosePath();

            calibrationSection.style.display = "none";
            screenSection.style.display = "block";
        });

        // Screen Slider
        screenSlider.addEventListener("mousedown", () => {
            startTime = Date.now();
            fetch(url + "startTime/" + startTime);
        });

        screenSlider.addEventListener("mouseup", () => {
            if (screenSlider.value >= screenSlider.max) {
                stopTime = Date.now();
                fetch(url + "stopTime/" + stopTime);

                setTimeout(() => {
                    screenSlider.value = 0;
                    intensity_slider.value = 0;
                    height_slider.value = 0;
                    nextMode();
                    screenSection.style.display = "none";
                    questionnaireSection.style.display = "block";
                }, 100);
            } else {
                alert("Please start from the beginning");
                screenSlider.value = 0;
            }
        });

        screenSlider.addEventListener("input", () => {
            const picoValue = realTimeCalculation();
            /* const currentMode = modeMatrix[participation_id_matrix][currentModeIndex]; */
            const currentCondition = shuffledConditionMatrix[currentModeIndex];
            const currentMode = currentCondition[1]; // "up", "down", "olymp", "tartarus"
            const intensity = currentCondition[2]; // 25, 50, 75, 100
            const maxValue = currentCondition[3]; // 100

            const endpoint = url + "main/" + picoValue;
            console.log(`üì§ Mode "${currentMode}" ‚Üí PicoValue: ${picoValue}`);
            fetch(endpoint).catch((err) => console.error("‚ùå Fetch error:", err));
        });

        // the Modes
        // https://damienmasson.com/tools/latin_square/
        const modeMatrix = [
            [/* 0: */ "up", "down", "tartarus", "olymp"],
            [/* 1: */ "down", "olymp", "up", "tartarus"],
            [/* 2: */ "olymp", "tartarus", "down", "up"],
            [/* 3: */ "tartarus", "up", "olymp", "down"],
        ];

        //Random Seed creation
        function seededRandom(seed) {
            let x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function shuffleArray(array, seed) {
            const arr = array.slice(); // copy
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        const conditionMatrix = [
            [0, "up", 50, 100],
            [1, "down", 50, 100],
            [2, "olymp", 50, 100],
            [3, "tartarus", 50, 100],
        ];

        function setupConditionMatrix(participantId) {
            /* participation_id_matrix = participantId; */
            shuffledConditionMatrix = shuffleArray(conditionMatrix, participantId);
        }

        function choosePath() {
            /* const currentMode = modeMatrix[participation_id_matrix][currentModeIndex]; */
            const currentCondition = shuffledConditionMatrix[currentModeIndex];
            fetch(url + "array/" + currentCondition);
            const currentMode = currentCondition[1]; // "up", "down", "olymp", "tartarus"
            const intensity = currentCondition[2]; // 25, 50, 75, 100
            const maxValue = currentCondition[3]; // 100
            console.log(`üéØ Starting mode: ${currentMode}`);
            fetch(url + "mode/" + currentMode);
        }

        function nextMode() {
            currentModeIndex++;
            if (currentModeIndex >= shuffledConditionMatrix.length) {
                currentModeIndex = 0;
                console.log("üîÅ Restarting mode cycle");
            }
            choosePath();
        }

        // ===== CALCULATION =====
        function realTimeCalculation() {
            const sliderValue = parseInt(screenSlider.value);
            const min_pico_value = calibrationValue;
            /* const max_pico_value = 80 + calibrationValue; */
            const currentCondition = shuffledConditionMatrix[currentModeIndex];
            const currentIndex = currentCondition[0];
            const max_pico_value = currentCondition[3] + calibrationValue;

            let actualPicoValue =
                min_pico_value + (sliderValue / 100) * (max_pico_value - min_pico_value);

            /* const currentMode = modeMatrix[participation_id_matrix][currentModeIndex]; */
            /* const currentMode = shuffledConditionMatrix[currentModeIndex][1]; */
            const currentMode = currentCondition[1]; // "up", "down", "olymp", or "tartarus"
            console.log(
                `üßÆ Index: ${currentIndex} | Mode: ${currentMode} | Max Pico: ${max_pico_value} | Min Pico: ${min_pico_value}`
            );

            if (currentMode === "down") {
                actualPicoValue = max_pico_value - (actualPicoValue - min_pico_value);
            } else if (currentMode === "olymp") {
                if (sliderValue <= 50) {
                    actualPicoValue =
                        min_pico_value +
                        (sliderValue / 100) * (max_pico_value - min_pico_value);
                } else {
                    actualPicoValue = max_pico_value - (actualPicoValue - min_pico_value);
                }
            } else if (currentMode === "tartarus") {
                if (sliderValue > 50) {
                    actualPicoValue =
                        min_pico_value +
                        (sliderValue / 100) * (max_pico_value - min_pico_value);
                } else {
                    actualPicoValue = max_pico_value - (actualPicoValue - min_pico_value);
                }
            }

            return Math.round(actualPicoValue);
        }

        // Questionnaire
        // Coordinates
        const canvasData = {
            rise: { x1: 150, y1: 150, x2: 150, y2: 50, x3: 50, y3: 150 },
            fall: { x1: 50, y1: 150, x2: 50, y2: 50, x3: 150, y3: 150 },
            olymp: { x1: 20, y1: 150, x2: 100, y2: 50, x3: 180, y3: 150 },
            tartarus: {
                x1: 20,
                y1: 50,
                x2: 20,
                y2: 150,
                x3: 180,
                y3: 150,
                x4: 180,
                y4: 50,
                x5: 100,
                y5: 120,
            },
        };

        // Functions that draw the forms
        function rise_and_fall(id, ctx) {
            const data = canvasData[id];
            ctx.clearRect(0, 0, 200, 200);
            ctx.beginPath();
            ctx.moveTo(data.x1, data.y1);
            ctx.lineTo(data.x2, data.y2);
            ctx.lineTo(data.x3, data.y3);
            ctx.closePath();
            ctx.stroke();

            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(data.x2, data.y2);
            ctx.lineTo(data.x3, data.y3);
            ctx.strokeStyle = "white";
            ctx.stroke();
        }

        function olymp(id, ctx) {
            const data = canvasData[id];
            ctx.clearRect(0, 0, 200, 200);
            ctx.beginPath();
            ctx.moveTo(data.x1, data.y1);
            ctx.lineTo(data.x2, data.y2);
            ctx.lineTo(data.x3, data.y3);
            ctx.closePath();
            ctx.stroke();

            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(data.x1, data.y1);
            ctx.lineTo(data.x2, data.y2);
            ctx.lineTo(data.x3, data.y3);
            ctx.strokeStyle = "white";
            ctx.stroke();
        }

        function tartarus(id, ctx) {
            const data = canvasData[id];
            ctx.clearRect(0, 0, 200, 200);
            ctx.beginPath();
            ctx.moveTo(data.x1, data.y1);
            ctx.lineTo(data.x2, data.y2);
            ctx.lineTo(data.x3, data.y3);
            ctx.lineTo(data.x4, data.y4);
            ctx.lineTo(data.x5, data.y5);
            ctx.closePath();
            ctx.stroke();

            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(data.x1, data.y1);
            ctx.lineTo(data.x5, data.y5);
            ctx.lineTo(data.x4, data.y4);
            ctx.strokeStyle = "white";
            ctx.stroke();
        }

        document.addEventListener("DOMContentLoaded", () => {
            Object.keys(canvasData).forEach((id) => {
                const canvas = document.getElementById(`${id}Canvas`);
                const ctx = canvas.getContext("2d");
                switch (id) {
                    case "olymp":
                        olymp(id, ctx);
                        break;
                    case "tartarus":
                        tartarus(id, ctx);
                        break;
                    default:
                        rise_and_fall(id, ctx);
                }
            });
        });

        let selectedCanvas = null; // Variable to track the selected canvas

        // Button Functions
        // Enter Buttons

        const canvas_section_container = document.getElementById(
            "canvas_section_container"
        );

        const intensity_send = document.getElementById("intensity_send");
        const intensity_return = document.getElementById("intensity_return");

        const height_send = document.getElementById("height_send");
        const height_return = document.getElementById("height_return");

        const intensity_container = document.getElementById("intensity_container");
        const height_container = document.getElementById("height_container");

        function buttonFunctions(canvas) {
            intensity_container.scrollIntoView({ behavior: "smooth" });
            selectedCanvas = canvas;
            console.log(selectedCanvas);
        }

        intensity_send.addEventListener("click", () => {
            height_container.scrollIntoView({ behavior: "smooth" });
        });
        intensity_return.addEventListener("click", () => {
            canvas_section_container.scrollIntoView({ behavior: "smooth" });
        });

        height_return.addEventListener("click", () => {
            intensity_container.scrollIntoView({ behavior: "smooth" });
        });

        //Send [canvas, intensity, height]
        const intensity_slider = document.getElementById("intensity_slider");
        const height_slider = document.getElementById("height_slider");

        height_send.addEventListener("click", () => {
            let intensity = intensity_slider.value;
            let height = height_slider.value;
            fetch(url + "canvas/" + selectedCanvas);
            fetch(url + "intensity/" + intensity);
            fetch(url + "height/" + height);

            questionnaireSection.style.display = "none";
            screenSection.style.display = "block";
        });

    </script>
</body>

</html>